{% extends 'base.html' %}
{% block title %}Discover Groups - Academic Assistant{% endblock %}
{% block content %}
<style>
    .dg-page { max-width: 680px; margin: 0 auto; }

    /* Header */
    .dg-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .dg-back {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: var(--white);
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-gray);
        text-decoration: none;
        transition: all 0.2s;
        flex-shrink: 0;
    }
    .dg-back:hover { border-color: #7C3AED; color: #7C3AED; }
    .dg-back svg { width: 18px; height: 18px; }
    .dg-header-text h1 {
        font-size: 1.35rem;
        font-weight: 700;
        color: var(--text-dark);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .dg-header-text h1 svg { width: 22px; height: 22px; color: #7C3AED; }
    .dg-header-text p { font-size: 0.8rem; color: var(--text-gray); margin-top: 0.1rem; }

    /* Search */
    .dg-search {
        background: var(--white);
        border-radius: 14px;
        border: 1px solid var(--border-color);
        padding: 1.25rem;
        margin-bottom: 1.5rem;
    }
    .dg-search-form {
        display: flex;
        gap: 0.75rem;
    }
    .dg-search-form input {
        flex: 1;
        padding: 0.6rem 0.75rem;
        border: 1.5px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.875rem;
        font-family: inherit;
        color: var(--text-dark);
        transition: border-color 0.2s;
    }
    .dg-search-form input:focus { outline: none; border-color: #7C3AED; }
    .dg-search-btn {
        padding: 0.6rem 1.25rem;
        background: linear-gradient(135deg, #7C3AED, #6C63FF);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
    }
    .dg-search-btn:hover { opacity: 0.9; }
    .dg-search-btn svg { width: 14px; height: 14px; }

    /* Card Stack */
    .dg-stack {
        position: relative;
        min-height: 520px;
        perspective: 1000px;
    }

    /* Group Card */
    .dg-card {
        background: var(--white);
        border-radius: 18px;
        border: 1px solid var(--border-color);
        box-shadow: 0 8px 30px rgba(0,0,0,0.08);
        padding: 2rem;
        position: absolute;
        width: 100%;
        transition: all 0.35s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    .dg-card.swipe-left {
        transform: translateX(-800px) rotate(-25deg);
        opacity: 0;
    }
    .dg-card.swipe-right {
        transform: translateX(800px) rotate(25deg);
        opacity: 0;
    }

    .dg-card-top {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .dg-group-icon {
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, #7C3AED, #6C63FF);
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        flex-shrink: 0;
    }
    .dg-group-icon svg { width: 26px; height: 26px; }
    .dg-group-name {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text-dark);
        line-height: 1.2;
    }
    .dg-group-meta {
        display: flex;
        gap: 0.75rem;
        margin-top: 0.3rem;
    }
    .dg-group-meta span {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.8rem;
        color: var(--text-gray);
    }
    .dg-group-meta svg { width: 13px; height: 13px; }

    .dg-match {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        background: linear-gradient(135deg, #7C3AED, #6C63FF);
        color: white;
        padding: 0.2rem 0.65rem;
        border-radius: 20px;
        font-size: 0.72rem;
        font-weight: 700;
    }
    .dg-match svg { width: 11px; height: 11px; }

    .dg-desc {
        color: var(--text-gray);
        line-height: 1.6;
        font-size: 0.9rem;
        margin-bottom: 1rem;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .dg-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1.25rem;
    }
    .dg-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        background: #F3E8FF;
        color: #7C3AED;
        padding: 0.35rem 0.75rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.78rem;
    }
    .dg-badge svg { width: 13px; height: 13px; }

    /* Message textarea */
    .dg-msg-box {
        margin-bottom: 1.25rem;
    }
    .dg-msg-box label {
        display: block;
        font-size: 0.78rem;
        font-weight: 600;
        color: var(--text-gray);
        margin-bottom: 0.35rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    .dg-msg-box textarea {
        width: 100%;
        padding: 0.65rem 0.75rem;
        border: 1.5px solid var(--border-color);
        border-radius: 8px;
        font-family: inherit;
        font-size: 0.85rem;
        resize: vertical;
        min-height: 70px;
        color: var(--text-dark);
        transition: border-color 0.2s;
    }
    .dg-msg-box textarea:focus {
        border-color: #7C3AED;
        outline: none;
    }

    /* Action Buttons */
    .dg-actions {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1.25rem;
        margin-top: 0.5rem;
    }
    .dg-act-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 2px solid transparent;
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    .dg-act-btn svg { width: 22px; height: 22px; }
    .dg-act-btn:hover { transform: scale(1.12); }
    .dg-act-btn.reject {
        background: #FEE2E2;
        color: #DC2626;
        border-color: #FECACA;
    }
    .dg-act-btn.reject:hover { background: #FCA5A5; }
    .dg-act-btn.skip {
        background: #F3F4F6;
        color: var(--text-gray);
        border-color: #E5E7EB;
        width: 48px;
        height: 48px;
    }
    .dg-act-btn.skip svg { width: 18px; height: 18px; }
    .dg-act-btn.skip:hover { background: #E5E7EB; }
    .dg-act-btn.accept {
        background: #D1FAE5;
        color: #059669;
        border-color: #A7F3D0;
    }
    .dg-act-btn.accept:hover { background: #6EE7B7; }

    .dg-act-label {
        font-size: 0.65rem;
        color: var(--text-gray);
        text-align: center;
        margin-top: 0.3rem;
    }
    .dg-act-group {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* Keyboard hint */
    .dg-kb-hint {
        text-align: center;
        margin-top: 1rem;
        font-size: 0.72rem;
        color: var(--text-gray);
        opacity: 0.7;
    }
    .dg-kb-hint kbd {
        display: inline-block;
        padding: 0.1rem 0.4rem;
        background: var(--white);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.65rem;
        font-family: inherit;
        margin: 0 0.1rem;
    }

    /* Empty State */
    .dg-empty {
        text-align: center;
        padding: 3.5rem 2rem;
        background: var(--white);
        border-radius: 18px;
        border: 1px solid var(--border-color);
    }
    .dg-empty-icon { font-size: 3.5rem; margin-bottom: 0.75rem; }
    .dg-empty h2 { font-size: 1.2rem; color: var(--text-dark); margin-bottom: 0.4rem; }
    .dg-empty p {
        color: var(--text-gray);
        font-size: 0.875rem;
        margin-bottom: 1.25rem;
        max-width: 340px;
        margin-left: auto;
        margin-right: auto;
    }
    .dg-empty-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.6rem 1.25rem;
        background: linear-gradient(135deg, #7C3AED, #6C63FF);
        color: white;
        border-radius: 10px;
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 600;
        transition: opacity 0.2s;
    }
    .dg-empty-btn:hover { opacity: 0.9; }

    /* Toast */
    .dg-toast {
        position: fixed;
        top: 5rem;
        right: 1.5rem;
        background: var(--white);
        padding: 0.875rem 1.25rem;
        border-radius: 10px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        z-index: 1000;
        display: none;
        max-width: 320px;
        font-size: 0.875rem;
        color: var(--text-dark);
        border-left: 4px solid #7C3AED;
    }
    .dg-toast.show { display: block; animation: dgSlideIn 0.3s ease-out; }
    .dg-toast.success { border-left-color: var(--success); }
    .dg-toast.info { border-left-color: #7C3AED; }
    @keyframes dgSlideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @media (max-width: 600px) {
        .dg-page { padding: 0 0.25rem; }
        .dg-card { padding: 1.5rem 1.25rem; }
        .dg-group-name { font-size: 1.1rem; }
        .dg-group-icon { width: 46px; height: 46px; border-radius: 12px; }
        .dg-group-icon svg { width: 22px; height: 22px; }
        .dg-search-form { flex-direction: column; }
        .dg-search-btn { width: 100%; justify-content: center; }
    }
</style>

<div class="dg-page">
    <!-- Header -->
    <div class="dg-header">
        <a href="{% url 'discovery_home' %}" class="dg-back">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
        </a>
        <div class="dg-header-text">
            <h1>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                Discover Groups
            </h1>
            <p>Find study groups that match your interests</p>
        </div>
    </div>

    <!-- Search -->
    <div class="dg-search">
        <form method="GET" class="dg-search-form">
            <input type="text" name="q" placeholder="Search groups by name..." value="{{ search_query }}">
            <button type="submit" class="dg-search-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                Search
            </button>
        </form>
    </div>

    {% if groups %}
    <!-- Card Stack -->
    <div class="dg-stack" id="card-stack">
        {% for group in groups %}
        <div class="dg-card" data-group-id="{{ group.id }}">
            <div class="dg-card-top">
                <div class="dg-group-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                </div>
                <div>
                    <div class="dg-group-name">{{ group.name }}</div>
                    <div class="dg-group-meta">
                        <span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            {{ group.member_count }} member{{ group.member_count|pluralize }}
                        </span>
                        {% if group.match_score > 0 %}
                        <span class="dg-match">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                            {{ group.match_score }}% Match
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="dg-desc">
                {{ group.description|default:"No description provided." }}
            </div>

            <div class="dg-badges">
                <div class="dg-badge">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    Created {{ group.created_at|date:"M Y" }}
                </div>
                <div class="dg-badge">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                    {{ group.member_count }} member{{ group.member_count|pluralize }}
                </div>
            </div>

            <div class="dg-msg-box">
                <label>Message to Admins (Optional)</label>
                <textarea id="message-{{ group.id }}" placeholder="Introduce yourself and explain why you'd like to join..."></textarea>
            </div>

            <div class="dg-actions">
                <div class="dg-act-group">
                    <button class="dg-act-btn reject" data-action="not_interested">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                    <span class="dg-act-label">Pass</span>
                </div>
                <div class="dg-act-group">
                    <button class="dg-act-btn skip" data-action="skip">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="5 12 12 5 19 12"/><line x1="12" y1="19" x2="12" y2="5"/></svg>
                    </button>
                    <span class="dg-act-label">Skip</span>
                </div>
                <div class="dg-act-group">
                    <button class="dg-act-btn accept" data-action="interested">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                    </button>
                    <span class="dg-act-label">Join</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="dg-kb-hint">
        <kbd>‚Üê</kbd> Pass &nbsp; <kbd>‚Üí</kbd> Skip &nbsp; <kbd>‚Üë</kbd> or <kbd>Space</kbd> Join
    </div>

    {% else %}
    <div class="dg-empty">
        <div class="dg-empty-icon">üéâ</div>
        <h2>You've Seen All Groups!</h2>
        <p>No more groups to discover right now. Try adjusting your search or check back later for new groups.</p>
        <a href="{% url 'discovery_home' %}" class="dg-empty-btn">
            <svg style="width: 16px; height: 16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
            Back to Discovery
        </a>
    </div>
    {% endif %}
</div>

<div id="toast" class="dg-toast"></div>

<script>
var groupCount = JSON.parse('{{ groups|length }}');
let currentCardIndex = groupCount - 1;
const cards = document.querySelectorAll('.dg-card');

cards.forEach((card, index) => {
    card.style.zIndex = cards.length - index;
    if (index !== currentCardIndex) {
        card.style.display = 'none';
    }
});

document.querySelectorAll('.dg-act-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const card = this.closest('.dg-card');
        handleAction(card.dataset.groupId, this.dataset.action);
    });
});

function handleAction(groupId, action) {
    const currentCard = document.querySelector(`.dg-card[data-group-id="${groupId}"]`);
    if (!currentCard) return;

    const message = document.getElementById(`message-${groupId}`).value;

    if (action === 'interested') {
        currentCard.classList.add('swipe-right');
    } else if (action === 'not_interested') {
        currentCard.classList.add('swipe-left');
    } else {
        currentCard.style.opacity = '0';
        currentCard.style.transform = 'scale(0.8)';
    }

    fetch(`/resources/discover/groups/${groupId}/action/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `action=${action}&message=${encodeURIComponent(message)}`
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
        }
    })
    .catch(err => console.error('Error:', err));

    setTimeout(() => {
        currentCard.remove();
        currentCardIndex--;

        if (currentCardIndex >= 0) {
            cards[currentCardIndex].style.display = 'block';
        } else {
            document.getElementById('card-stack').innerHTML = `
                <div class="dg-empty">
                    <div class="dg-empty-icon">üéâ</div>
                    <h2>You've Seen All Groups!</h2>
                    <p>Great job exploring! Check your requests at the discovery home.</p>
                    <a href="{% url 'discovery_home' %}" class="dg-empty-btn">Back to Discovery</a>
                </div>
            `;
        }
    }, 350);
}

function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `dg-toast ${type} show`;
    setTimeout(() => { toast.classList.remove('show'); }, 3000);
}

document.addEventListener('keydown', (e) => {
    if (currentCardIndex < 0) return;
    const gid = cards[currentCardIndex]?.dataset.groupId;
    if (!gid) return;
    if (e.key === 'ArrowLeft') handleAction(gid, 'not_interested');
    else if (e.key === 'ArrowRight') handleAction(gid, 'skip');
    else if (e.key === 'ArrowUp' || e.key === ' ') { e.preventDefault(); handleAction(gid, 'interested'); }
});
</script>
{% endblock %}
