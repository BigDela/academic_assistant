{% extends 'base.html' %}
{% block title %}Discover People - Academic Assistant{% endblock %}
{% block content %}
<style>
    .du-page { max-width: 680px; margin: 0 auto; }

    /* Header */
    .du-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .du-back {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: var(--white);
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-gray);
        text-decoration: none;
        transition: all 0.2s;
        flex-shrink: 0;
    }
    .du-back:hover { border-color: var(--primary-blue); color: var(--primary-blue); }
    .du-back svg { width: 18px; height: 18px; }
    .du-header-text h1 {
        font-size: 1.35rem;
        font-weight: 700;
        color: var(--text-dark);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .du-header-text h1 svg { width: 22px; height: 22px; color: var(--primary-blue); }
    .du-header-text p { font-size: 0.8rem; color: var(--text-gray); margin-top: 0.1rem; }

    /* Search */
    .du-search {
        background: var(--white);
        border-radius: 14px;
        border: 1px solid var(--border-color);
        padding: 1.25rem;
        margin-bottom: 1.5rem;
    }
    .du-search-form {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: flex-end;
    }
    .du-field { flex: 1; min-width: 160px; }
    .du-field label {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-gray);
        margin-bottom: 0.35rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    .du-field input,
    .du-field select {
        width: 100%;
        padding: 0.6rem 0.75rem;
        border: 1.5px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.875rem;
        font-family: inherit;
        background: var(--white);
        color: var(--text-dark);
        transition: border-color 0.2s;
    }
    .du-field input:focus,
    .du-field select:focus {
        outline: none;
        border-color: var(--primary-blue);
    }
    .du-search-btn {
        padding: 0.6rem 1.25rem;
        background: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
    }
    .du-search-btn:hover { background: var(--dark-blue); }
    .du-search-btn svg { width: 14px; height: 14px; }

    /* Card Stack */
    .du-stack {
        position: relative;
        min-height: 480px;
        perspective: 1000px;
    }

    /* User Card */
    .du-card {
        background: var(--white);
        border-radius: 18px;
        border: 1px solid var(--border-color);
        box-shadow: 0 8px 30px rgba(0,0,0,0.08);
        padding: 2rem 2rem 1.5rem;
        text-align: center;
        position: absolute;
        width: 100%;
        transition: all 0.35s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        cursor: grab;
    }
    .du-card:active { cursor: grabbing; }
    .du-card.swipe-left {
        transform: translateX(-800px) rotate(-25deg);
        opacity: 0;
    }
    .du-card.swipe-right {
        transform: translateX(800px) rotate(25deg);
        opacity: 0;
    }

    .du-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        margin: 0 auto 1rem;
        background: linear-gradient(135deg, var(--primary-blue), #6C63FF);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2.5rem;
        font-weight: 700;
        object-fit: cover;
        border: 3px solid var(--white);
        box-shadow: 0 4px 14px rgba(74,144,226,0.22);
    }

    .du-match {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        background: linear-gradient(135deg, var(--primary-blue), #6C63FF);
        color: white;
        padding: 0.3rem 0.9rem;
        border-radius: 20px;
        font-size: 0.78rem;
        font-weight: 700;
        margin-bottom: 0.75rem;
    }
    .du-match svg { width: 13px; height: 13px; }

    .du-name {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 0.15rem;
    }
    .du-username {
        font-size: 0.9rem;
        color: var(--text-gray);
        margin-bottom: 1rem;
    }

    .du-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
        gap: 0.6rem;
        margin: 1rem 0 1.5rem;
        text-align: left;
    }
    .du-info-item {
        background: var(--light-blue);
        padding: 0.75rem 0.875rem;
        border-radius: 10px;
    }
    .du-info-label {
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--text-gray);
        text-transform: uppercase;
        letter-spacing: 0.3px;
        margin-bottom: 0.15rem;
    }
    .du-info-value {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-dark);
    }

    /* Action Buttons */
    .du-actions {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1.25rem;
        margin-top: 0.5rem;
    }
    .du-act-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 2px solid transparent;
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    .du-act-btn svg { width: 22px; height: 22px; }
    .du-act-btn:hover { transform: scale(1.12); }
    .du-act-btn.reject {
        background: #FEE2E2;
        color: #DC2626;
        border-color: #FECACA;
    }
    .du-act-btn.reject:hover { background: #FCA5A5; }
    .du-act-btn.skip {
        background: #F3F4F6;
        color: var(--text-gray);
        border-color: #E5E7EB;
        width: 48px;
        height: 48px;
    }
    .du-act-btn.skip svg { width: 18px; height: 18px; }
    .du-act-btn.skip:hover { background: #E5E7EB; }
    .du-act-btn.accept {
        background: #D1FAE5;
        color: #059669;
        border-color: #A7F3D0;
    }
    .du-act-btn.accept:hover { background: #6EE7B7; }

    .du-act-label {
        font-size: 0.65rem;
        color: var(--text-gray);
        text-align: center;
        margin-top: 0.3rem;
    }
    .du-act-group {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* Keyboard hint */
    .du-kb-hint {
        text-align: center;
        margin-top: 1rem;
        font-size: 0.72rem;
        color: var(--text-gray);
        opacity: 0.7;
    }
    .du-kb-hint kbd {
        display: inline-block;
        padding: 0.1rem 0.4rem;
        background: var(--white);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.65rem;
        font-family: inherit;
        margin: 0 0.1rem;
    }

    /* Empty State */
    .du-empty {
        text-align: center;
        padding: 3.5rem 2rem;
        background: var(--white);
        border-radius: 18px;
        border: 1px solid var(--border-color);
    }
    .du-empty-icon {
        font-size: 3.5rem;
        margin-bottom: 0.75rem;
    }
    .du-empty h2 {
        font-size: 1.2rem;
        color: var(--text-dark);
        margin-bottom: 0.4rem;
    }
    .du-empty p {
        color: var(--text-gray);
        font-size: 0.875rem;
        margin-bottom: 1.25rem;
        max-width: 340px;
        margin-left: auto;
        margin-right: auto;
    }
    .du-empty-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.6rem 1.25rem;
        background: var(--primary-blue);
        color: white;
        border-radius: 10px;
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 600;
        transition: background 0.2s;
    }
    .du-empty-btn:hover { background: var(--dark-blue); }

    /* Toast */
    .du-toast {
        position: fixed;
        top: 5rem;
        right: 1.5rem;
        background: var(--white);
        padding: 0.875rem 1.25rem;
        border-radius: 10px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        z-index: 1000;
        display: none;
        max-width: 320px;
        font-size: 0.875rem;
        color: var(--text-dark);
        border-left: 4px solid var(--primary-blue);
    }
    .du-toast.show { display: block; animation: duSlideIn 0.3s ease-out; }
    .du-toast.success { border-left-color: var(--success); }
    .du-toast.info { border-left-color: var(--primary-blue); }
    @keyframes duSlideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @media (max-width: 600px) {
        .du-page { padding: 0 0.25rem; }
        .du-card { padding: 1.5rem 1.25rem 1.25rem; }
        .du-avatar { width: 80px; height: 80px; font-size: 2rem; }
        .du-name { font-size: 1.2rem; }
        .du-info-grid { grid-template-columns: 1fr 1fr; }
        .du-search-form { flex-direction: column; }
        .du-search-btn { width: 100%; justify-content: center; }
    }
</style>

<div class="du-page">
    <!-- Header -->
    <div class="du-header">
        <a href="{% url 'discovery_home' %}" class="du-back">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
        </a>
        <div class="du-header-text">
            <h1>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                Discover People
            </h1>
            <p>Swipe through profiles to find your next study buddy</p>
        </div>
    </div>

    <!-- Search & Filters -->
    <div class="du-search">
        <form method="GET" class="du-search-form">
            <div class="du-field">
                <label>Search</label>
                <input type="text" name="q" placeholder="Name or username..." value="{{ search_query }}">
            </div>
            <div class="du-field">
                <label>Course</label>
                <select name="course">
                    <option value="">All Courses</option>
                    {% for course in courses %}
                    <option value="{{ course }}" {% if course == course_filter %}selected{% endif %}>{{ course }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="du-search-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                Search
            </button>
        </form>
    </div>

    {% if users %}
    <!-- Card Stack -->
    <div class="du-stack" id="card-stack">
        {% for discovered_user in users %}
        <div class="du-card" data-user-id="{{ discovered_user.id }}">
            {% if discovered_user.profile.profile_picture %}
            <img src="{{ discovered_user.profile.profile_picture.url }}" alt="{{ discovered_user.username }}" class="du-avatar">
            {% else %}
            <div class="du-avatar">{{ discovered_user.username|slice:":1"|upper }}</div>
            {% endif %}

            {% if discovered_user.match_score > 0 %}
            <div class="du-match">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                {{ discovered_user.match_score }}% Match
            </div>
            {% endif %}

            <div class="du-name">
                {% if discovered_user.first_name %}{{ discovered_user.first_name }} {{ discovered_user.last_name }}{% else %}{{ discovered_user.username }}{% endif %}
            </div>
            <div class="du-username">@{{ discovered_user.username }}</div>

            <div class="du-info-grid">
                <div class="du-info-item">
                    <div class="du-info-label">Course</div>
                    <div class="du-info-value">{{ discovered_user.get_course_display }}</div>
                </div>
                <div class="du-info-item">
                    <div class="du-info-label">Year</div>
                    <div class="du-info-value">{{ discovered_user.get_year_display }}</div>
                </div>
                {% if discovered_user.profile.program_of_study %}
                <div class="du-info-item">
                    <div class="du-info-label">Program</div>
                    <div class="du-info-value">{{ discovered_user.profile.program_of_study }}</div>
                </div>
                {% endif %}
            </div>

            <div class="du-actions">
                <div class="du-act-group">
                    <button class="du-act-btn reject" data-user-id="{{ discovered_user.id }}" data-action="reject">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                    <span class="du-act-label">Pass</span>
                </div>
                <div class="du-act-group">
                    <button class="du-act-btn skip" data-user-id="{{ discovered_user.id }}" data-action="skip">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="5 12 12 5 19 12"/><line x1="12" y1="19" x2="12" y2="5"/></svg>
                    </button>
                    <span class="du-act-label">Skip</span>
                </div>
                <div class="du-act-group">
                    <button class="du-act-btn accept" data-user-id="{{ discovered_user.id }}" data-action="accept">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                    </button>
                    <span class="du-act-label">Connect</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="du-kb-hint">
        <kbd>‚Üê</kbd> Pass &nbsp; <kbd>‚Üí</kbd> Skip &nbsp; <kbd>‚Üë</kbd> or <kbd>Space</kbd> Connect
    </div>

    {% else %}
    <div class="du-empty">
        <div class="du-empty-icon">üéâ</div>
        <h2>You've Seen Everyone!</h2>
        <p>No more users to discover right now. Try adjusting your search filters or check back later for new members.</p>
        <a href="{% url 'discovery_home' %}" class="du-empty-btn">
            <svg style="width: 16px; height: 16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
            Back to Discovery
        </a>
    </div>
    {% endif %}
</div>

<div id="toast" class="du-toast"></div>

{{ users|length|add:"-1"|json_script:"users-count" }}

<script>
let currentCardIndex = JSON.parse(document.getElementById('users-count').textContent);
const cards = document.querySelectorAll('.du-card');

// Position cards in stack
cards.forEach((card, index) => {
    card.style.zIndex = cards.length - index;
    if (index !== currentCardIndex) {
        card.style.display = 'none';
    }
});

// Attach click handlers to action buttons
document.querySelectorAll('.du-act-btn[data-user-id]').forEach(btn => {
    btn.addEventListener('click', function() {
        handleAction(this.dataset.userId, this.dataset.action);
    });
});

function handleAction(userId, action) {
    const currentCard = document.querySelector(`.du-card[data-user-id="${userId}"]`);
    if (!currentCard) return;

    if (action === 'accept') {
        currentCard.classList.add('swipe-right');
    } else if (action === 'reject') {
        currentCard.classList.add('swipe-left');
    } else {
        currentCard.style.opacity = '0';
        currentCard.style.transform = 'scale(0.8)';
    }

    fetch(`/resources/discover/users/${userId}/action/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `action=${action}`
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, data.friend_matched ? 'success' : 'info');
        }
    })
    .catch(err => console.error('Error:', err));

    setTimeout(() => {
        currentCard.remove();
        currentCardIndex--;

        if (currentCardIndex >= 0) {
            cards[currentCardIndex].style.display = 'block';
        } else {
            document.getElementById('card-stack').innerHTML = `
                <div class="du-empty">
                    <div class="du-empty-icon">üéâ</div>
                    <h2>You've Seen Everyone!</h2>
                    <p>Great job exploring! Come back later for new matches.</p>
                    <a href="{% url 'discovery_home' %}" class="du-empty-btn">Back to Discovery</a>
                </div>
            `;
        }
    }, 350);
}

function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `du-toast ${type} show`;
    setTimeout(() => { toast.classList.remove('show'); }, 3000);
}

document.addEventListener('keydown', (e) => {
    if (currentCardIndex < 0) return;
    const uid = cards[currentCardIndex]?.dataset.userId;
    if (!uid) return;
    if (e.key === 'ArrowLeft') handleAction(uid, 'reject');
    else if (e.key === 'ArrowRight') handleAction(uid, 'skip');
    else if (e.key === 'ArrowUp' || e.key === ' ') { e.preventDefault(); handleAction(uid, 'accept'); }
});
</script>
{% endblock %}
